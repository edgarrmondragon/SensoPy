name: Tests
on:
  pull_request: {}
  push:
    branches: [master]
jobs:
  tests:
    name: ${{ matrix.session }} ${{ matrix.python-version }}${{ matrix.slow && ' (slow)' || '' }} / ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    continue-on-error: false
    env:
      FORCE_COLOR: "1"
    strategy:
      fail-fast: false
      matrix:
        python-version:
        - "3.12"
        - "3.11"
        - "3.10"
        - "3.9"
        - "3.8"
        os:
        - "ubuntu-latest"
        include:
        - { python-version: "3.12", os: "ubuntu-latest", slow: true }
        - { python-version: "3.11", os: "windows-latest" }
        - { python-version: "3.11", os: "macos-latest" }

    steps:
    - uses: actions/checkout@v4.1.1
    - uses: actions/setup-python@v5.0.0
      id: python
      with:
        python-version: ${{ matrix.python-version }}
        architecture: x64

    - name: Install Hatch
      env:
        PIP_CONSTRAINT: .github/workflows/constraints.txt
      run: |
        pipx install --python=${{ steps.python.outputs.python-path }} hatch
        hatch --version

    - name: Test
      run: |
        hatch run test-cov -- ${{ matrix.slow && '-m slow' || '' }}

    - uses: actions/upload-artifact@v4.1.0
      with:
        name: coverage-data-${{ matrix.os }}-${{ matrix.python-version }}
        path: ".coverage.*"

    - if: ${{ !matrix.slow }}
      run: hatch run types:check

  coverage:
    runs-on: ubuntu-latest
    needs: tests
    steps:
    - uses: actions/checkout@v4.1.1
    - uses: actions/setup-python@v5.0.0
      with:
        python-version: "3.11"

    - name: Install Hatch
      env:
        PIP_CONSTRAINT: .github/workflows/constraints.txt
      run: |
        pipx install hatch
        hatch --version

    - uses: actions/download-artifact@v4.1.1
      with:
        pattern: coverage-data-*
        merge-multiple: true

    - run: hatch run cov-report
    - run: hatch run report -- xml
    - uses: codecov/codecov-action@v3.1.4
